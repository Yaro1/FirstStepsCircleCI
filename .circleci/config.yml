version: 2.1

jobs:
  build:
    environment:
      PGUSER: $PGUSER
      PGPASSWORD: $PGPASSWORD
      PGDATABASE: $PGDATABASE
      PGPORT: $PGPORT
      PGHOST: $PGHOST
    docker:
      - image: yaropv1/circleci
        auth:
          username: $DOCKERHUB_USER
          password: $DOCKERHUB_PASSWORD
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run: # https://circleci.com/docs/2.0/docker-layer-caching/
          name: "Build docker image"
          command: |
            docker run --cap-drop all yaropv1/circleci
      - run:
          name: "Difference in ddl"
          command: |
            git diff --no-commit-id --name-only -r master | sort -u >  files
            cat files | python roll_out.py

workflows:
  build-workflow:
    jobs:
      - build
#      - build:
#          filters:
#            branches:
#              only: master # only deploy when on master
